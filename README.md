# particle_filter_3d

## Introduction
This package provides 3D LiDAR based Monte Carlo Localization algorithm. It tracks robot's 3D pose using odometry and 3D LiDAR data input. 

## Prerequisites
1. ROS noetic
2. PCL >= 1.8
3. Eigen >= 3.3
4. Point cloud map (.pcd) : Can be generated by LiDAR SLAM algorithm, such as [LIO-SAM](https://github.com/TixiaoShan/LIO-SAM).


## Install
```
cd ~/catkin_ws/src

git clone https://github.com/nuninu98/particle_filter_3d.git

cd ~/catkin_ws && catkin_make
```

## ROS API
### Subscribe
- /velodyne_points (sensor_msgs/PointCloud2)
  - can be modified in param/config.yaml (lidar_topic)
- /odometry/filtered (nav_msgs/Odometry)
  - can be modified in param/config.yaml (odom_topic)
- /initialpose (geometry_msgs::PoseWithCovarianceStamped)
  - Used for initial pose guess and initialization. 
  - Recommend to use by RVIZ.
  ![particle filter](https://github.com/user-attachments/assets/603fefd0-4ad9-43c5-9679-65cfef9ccccd)
### Publish
- /localization_pose (nav_msgs/Odometry)
- /tf
- /particles (for vislualization)

## Setting
The algorithm setting can be modified in param/config.yaml file.

```yaml
lidar_topic: /velodyne_points # Subscribing LiDAR topic.
map_folder: "/home/nuninu98/test_ws/src/particle_filter_3d/map" # Map folder
map_file: "warehouse.pcd" # Map filename
publish_odom_tf: true # If true, odom -> baselink tf is generated.
voxel_size: 0.2 # LiDAR voxel grid downsampling. 
num_particles: 1500 # Number of particles.
alpha_v: 2.0 # Translational motion noise. Bigger, the particle spreads wider.
alpha_w: 0.2 # Rotational motion noise. 
imu_preintegration:
  enable: true # Enable the IMU preintegration.
  imu_topic: imu/data # IMU topic.
odom_topic: jackal_velocity_controller/odom # Only if the imu_preintegration disabled.
```

## Demo and Experiment

### Preparing world and map
First, generate the pcd map of the world.

These are the recommended gazebo simulation worlds: [logistics warehouse](https://github.com/belal-ibrahim/dynamic_logistics_warehouse), [hospital](https://github.com/aws-robotics/aws-robomaker-hospital-world)

[Jackal with velodyne](https://github.com/TixiaoShan/jackal_velodyne) might be a good robot simulator.

[LIO-SAM](https://github.com/TixiaoShan/LIO-SAM) can be used for generating pcd map.

#### Demo without LiDAR disturbance
The command below can run the localization. 
```
roslaunch particle_filter_3d particle_filter.launch
```

For the detail in particle_filter.launch, please check the below. 

```xml
<launch>
    <param name="use_sim_time" value="true"/>
    <node pkg="tf2_ros" name="static_tf" type="static_transform_publisher" args="0 0 0.4 0 0 0 1 base_link velodyne"/> <!-- For visualization-->
    <node pkg="particle_filter_3d" name="test_particle_filter" type="test_particle_filter" output="screen">
        <rosparam command="load" file="$(find particle_filter_3d)/param/config.yaml" />
    </node>

    <node pkg="particle_filter_3d" name="test_traj_record" type="test_traj_record" output="screen"> <!-- For recording data. You can disable this node if you do not need an evaluation. -->
        <param name="folder" value="$(find particle_filter_3d)/trajectory/"/> <!-- Data saving folder directory -->
        <param name="gt" value="warehouse_gt.txt"/> <!-- Saving ground truth trajectory  -->
        <param name="trajectory" value="warehouse_pf_imu.txt"/> <!-- Saving generated trajectory by this algorithm -->
    </node>
</launch>
```



#### Demo with LiDAR disturbance
If you run the following command, the robot localization will operate using the LiDAR data with random noise.
```
roslaunch particle_filter_3d particle_filter_degen.launch
```

For the detail in particle_filter_degen.launch, please check the below. 

```xml
<launch>
    <param name="use_sim_time" value="true"/>
    <node pkg="tf2_ros" name="static_tf" type="static_transform_publisher" args="0 0 0.4 0 0 0 1 base_link velodyne"/>
    <node pkg="particle_filter_3d" name="test_particle_filter" type="test_particle_filter" output="screen">
        <rosparam command="load" file="$(find particle_filter_3d)/param/config_degen.yaml" />
    </node>
    <node pkg="particle_filter_3d" name="test_lidar_degen" type="test_lidar_degen" output="screen"> <!-- Generating degenerated LiDAR data-->
        <param name="max_range" value="10.0"/>  <!-- Degeneracy max range -->
        <param name="degen_rate" value="0.3"/> <!-- Degenerated date rate out of the total input -->
        <param name="lidar" value="velodyne_points"/> <!-- Input LiDAR pointcloud -->
    </node>

    <node pkg="particle_filter_3d" name="test_traj_record" type="test_traj_record" output="screen"> <!-- For recording data. You can disable this node if you do not need an evaluation. -->
        <param name="folder" value="$(find particle_filter_3d)/trajectory/"/> <!-- Data saving folder directory -->
        <param name="gt" value="warehouse_gt.txt"/> <!-- Saving ground truth trajectory  -->
        <param name="trajectory" value="warehouse_pf_imu.txt"/> <!-- Saving generated trajectory by this algorithm -->
    </node>
</launch>
```

Experiment result is posted as the paper:

[Dynamic Environment Robust 3D LiDAR Based Monte Carlo Localization.pdf](https://github.com/user-attachments/files/15924770/Dynamic.Environment.Robust.3D.LiDAR.Based.Monte.Carlo.Localization.pdf)

Demo GIF
![particle filter](https://github.com/nuninu98/particle_filter_3d/assets/36870891/81c6ba3e-2962-4cfb-a360-70ef27d6d3da)

If the IMU preintegration enabled, first set the initial pose guess using RVIZ. Then do not move the robot for at least 5 secs(Requires IMU initialization).